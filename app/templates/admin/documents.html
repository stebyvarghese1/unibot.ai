{% extends "admin/base_admin.html" %}
{% block title %}Documents - Admin Dashboard{% endblock %}
{% block content %}
<div class="space-y-4 sm:space-y-6 w-full min-w-0">
  <!-- Document Upload Tabs -->
  <div class="bg-slate-900 rounded-[2rem] shadow-2xl border border-slate-800 overflow-hidden">
    <!-- Tab Switcher -->
    <div class="flex border-b border-slate-800 bg-slate-800/20 p-2 gap-2">
      <button onclick="switchTab('syllabus')" id="tab-syllabus"
        class="flex-1 flex items-center justify-center gap-3 py-4 rounded-2xl text-xs font-black uppercase tracking-widest transition-all duration-300 bg-indigo-600 text-white shadow-lg shadow-indigo-900/40">
        <i class="fa-solid fa-graduation-cap text-base"></i>
        <span>Course Materials</span>
      </button>
      <button onclick="switchTab('system')" id="tab-system"
        class="flex-1 flex items-center justify-center gap-3 py-4 rounded-2xl text-xs font-black uppercase tracking-widest transition-all duration-300 text-slate-500 hover:text-slate-300 hover:bg-slate-800/50">
        <i class="fa-solid fa-microchip text-base"></i>
        <span>System Intelligence</span>
      </button>
    </div>

    <!-- Syllabus Panel -->
    <div id="panel-syllabus" class="block">
      <div class="px-6 py-4 border-b border-slate-800 bg-slate-800/10 flex items-center gap-3">
        <div
          class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
          <i class="fa-solid fa-file-arrow-up text-sm"></i>
        </div>
        <h3 class="text-xs font-black text-slate-300 uppercase tracking-widest">Upload Course Knowledge</h3>
      </div>
      <div class="p-6">
        <form id="upload-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label
                class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Course</label>
              <select name="course" id="upload-course" required
                class="w-full px-5 py-3.5 bg-slate-950 border-2 border-slate-800 rounded-2xl focus:border-indigo-500 text-sm font-bold text-white outline-none transition-all">
                <option value="">Select Course</option>
              </select>
            </div>
            <div>
              <label
                class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Semester</label>
              <select name="semester" id="upload-semester" required
                class="w-full px-5 py-3.5 bg-slate-950 border-2 border-slate-800 rounded-2xl focus:border-indigo-500 text-sm font-bold text-white outline-none transition-all">
                <option value="">Select Semester</option>
              </select>
            </div>
            <div>
              <label
                class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Subject</label>
              <select name="subject" id="upload-subject" required
                class="w-full px-5 py-3.5 bg-slate-950 border-2 border-slate-800 rounded-2xl focus:border-indigo-500 text-sm font-bold text-white outline-none transition-all">
                <option value="">Select Subject</option>
              </select>
            </div>
          </div>

          <label for="file-input"
            class="flex flex-col items-center justify-center w-full h-44 border-2 border-slate-800 border-dashed rounded-[1.5rem] cursor-pointer bg-slate-950/50 hover:bg-indigo-500/5 hover:border-indigo-500/50 transition-all group">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <div
                class="w-14 h-14 rounded-2xl bg-indigo-500/10 text-indigo-400 flex items-center justify-center mb-4 group-hover:scale-110 group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-lg border border-indigo-500/20">
                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
              </div>
              <p class="mb-1 text-sm text-slate-400"><span class="font-black text-white">Click to select files</span>
              </p>
              <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mt-1">PDF • DOCX • PPTX (UP TO
                16MB)</p>
            </div>
            <input id="file-input" type="file" class="hidden" accept=".pdf,.docx,.pptx" />
          </label>

          <div class="flex flex-wrap items-center justify-between gap-4">
            <div id="file-name"
              class="text-[10px] font-black text-indigo-400 uppercase tracking-widest truncate max-w-xs"></div>
            <button type="submit"
              class="px-8 py-4 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-900/40 hover:bg-indigo-700 transition-all flex items-center gap-3">
              <i class="fa-solid fa-shuttle-space"></i> Deploy Knowledge
            </button>
          </div>
        </form>
        <div id="upload-status" class="mt-6 text-[10px] font-black text-center uppercase tracking-widest"></div>
      </div>
    </div>

    <!-- System Intelligence Panel -->
    <div id="panel-system" class="hidden">
      <div class="px-6 py-4 border-b border-slate-800 bg-slate-800/10 flex items-center gap-3">
        <div
          class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-400 border border-amber-500/20">
          <i class="fa-solid fa-brain text-sm"></i>
        </div>
        <h3 class="text-xs font-black text-slate-300 uppercase tracking-widest">Core System Alignment</h3>
      </div>
      <div class="p-6">
        <p class="text-[11px] font-medium text-slate-500 mb-6 max-w-2xl leading-relaxed">
          Upload technical specifications, manuals, or company identity documents. This data powers responses like <span
            class="text-indigo-400 font-bold">"Software capabilities"</span> and <span
            class="text-indigo-400 font-bold font-bold">"Who are you?"</span>.
        </p>

        <form id="system-upload-form" class="space-y-6">
          <input type="hidden" name="doc_type" value="system_info">
          <label for="system-file-input"
            class="flex flex-col items-center justify-center w-full h-44 border-2 border-slate-800 border-dashed rounded-[1.5rem] cursor-pointer bg-slate-950/50 hover:bg-amber-500/5 hover:border-amber-500/50 transition-all group">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <div
                class="w-14 h-14 rounded-2xl bg-amber-500/10 text-amber-400 flex items-center justify-center mb-4 group-hover:scale-110 group-hover:bg-amber-600 group-hover:text-white transition-all shadow-lg border border-amber-500/20">
                <i class="fa-solid fa-fingerprint text-xl"></i>
              </div>
              <p class="mb-1 text-sm text-slate-400"><span class="font-black text-white">Select Software Docs</span></p>
              <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mt-1">SYTEM MANIFESTO (PDF •
                DOCX)</p>
            </div>
            <input id="system-file-input" type="file" class="hidden" accept=".pdf,.docx" />
          </label>

          <div class="flex flex-wrap items-center justify-between gap-4">
            <div id="system-file-name"
              class="text-[10px] font-black text-amber-400 uppercase tracking-widest truncate max-w-xs"></div>
            <button type="submit"
              class="px-8 py-4 bg-amber-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-amber-900/40 hover:bg-amber-700 transition-all flex items-center gap-3">
              <i class="fa-solid fa-server"></i> Sync Intelligence
            </button>
          </div>
        </form>
        <div id="system-upload-status" class="mt-6 text-[10px] font-black text-center uppercase tracking-widest"></div>

        <!-- System Docs List Section -->
        <div id="system-docs-container" class="mt-10 pt-8 border-t border-slate-800 hidden">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Operational System Memory</h3>
          </div>
          <div class="overflow-x-auto rounded-2xl border border-slate-800/50">
            <table class="min-w-full divide-y divide-slate-800">
              <thead class="bg-slate-950">
                <tr>
                  <th class="px-4 py-3 text-left text-[9px] font-black text-slate-600 uppercase tracking-widest">
                    Identity Record</th>
                  <th class="px-4 py-3 text-left text-[9px] font-black text-slate-600 uppercase tracking-widest">
                    Alignment</th>
                  <th class="px-4 py-3 text-right text-[9px] font-black text-slate-600 uppercase tracking-widest">Matrix
                    Action</th>
                </tr>
              </thead>
              <tbody id="system-doc-list" class="divide-y divide-slate-800/50 bg-slate-900/50">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 p-4 sm:p-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      <div class="sm:col-span-2 lg:col-span-1">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Search</label>
        <div class="relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i
              class="fa-solid fa-search text-slate-600"></i></span><input type="text" id="search-filter"
            placeholder="Search..."
            class="w-full pl-10 pr-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
        </div>
      </div>
      <div class="w-full min-w-0">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Course</label>
        <select id="course-filter"
          class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
          <option value="">All Courses</option>
        </select>
      </div>
      <div class="w-full min-w-0">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Semester</label>
        <select id="sem-filter"
          class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
          <option value="">All Semesters</option>
        </select>
      </div>
      <div class="w-full min-w-0">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Subject</label>
        <select id="subj-filter"
          class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-purple-500 min-w-0">
          <option value="">All Subjects</option>
        </select>
      </div>
    </div>
  </div>
  <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden min-w-0">
    <div
      class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex flex-wrap justify-between items-center gap-2">
      <h2 class="text-base sm:text-lg font-semibold text-white truncate min-w-0">Uploaded Documents</h2>
      <button type="button" onclick="loadDocs()" class="btn-icon shrink-0 text-slate-300 hover:text-white"
        title="Refresh list"><i class="fa-solid fa-sync-alt"></i> Refresh</button>
    </div>
    <div class="overflow-x-auto hide-h-scrollbar">
      <table class="min-w-full divide-y divide-slate-800">
        <thead class="bg-slate-800/50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest min-w-[200px]">
              Filename
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-32">Course
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-24">Semester
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-24">Subject
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-32">Status
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest">Upload Date
            </th>
            <th class="px-6 py-3 text-right text-xs font-black text-slate-500 uppercase tracking-widest w-40">Actions
            </th>
          </tr>
        </thead>
        <tbody id="doc-list" class="bg-slate-900 divide-y divide-slate-800"></tbody>
      </table>
      <div id="empty-state" class="hidden py-12 text-center">
        <i class="fa-solid fa-file-invoice text-4xl text-slate-700 mb-4 opacity-50"></i>
        <p class="text-slate-500 font-medium">No documents found matching filters.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  let allDocs = [];
  let allFilters = [];



  // --- Upload form: load filter options and populate dropdowns ---
  async function loadFilterOptions() {
    try {
      const res = await fetch('/api/admin/filter-options');
      const data = await res.json();
      allFilters = data.all || [];
      initUploadForm();
    } catch (e) { console.error('Error loading filter options', e); }
  }

  function initUploadForm() {
    const cSelect = document.getElementById('upload-course');
    const sSelect = document.getElementById('upload-semester');
    if (!cSelect) return;
    const courses = allFilters.filter(x => x.category === 'course').sort((a, b) => a.value.localeCompare(b.value));
    uploadPopulateSelect(cSelect, courses, 'Select Course');
    cSelect.onchange = () => updateSemesters('upload');
    if (sSelect) sSelect.onchange = () => updateSubjects('upload');
    updateSemesters('upload');
  }



  function updateSemesters(prefix) {
    const cSelect = document.getElementById(prefix + '-course');
    const sSelect = document.getElementById(prefix + '-semester');
    const subSelect = document.getElementById(prefix + '-subject');
    if (!sSelect) return;

    const curS = sSelect.value;
    sSelect.innerHTML = '<option value="">Select Semester</option>';
    if (subSelect) subSelect.innerHTML = '<option value="">Select Subject</option>';

    const cVal = cSelect ? cSelect.value : '';
    const courseObj = allFilters.find(x => x.category === 'course' && x.value === cVal);
    let semesters = courseObj
      ? allFilters.filter(x => x.category === 'semester' && x.parent_id === courseObj.id)
      : allFilters.filter(x => x.category === 'semester');
    semesters = semesters.sort((a, b) => a.value.localeCompare(b.value));
    uploadPopulateSelect(sSelect, semesters, 'Select Semester');
    // Attempt to preserve value if valid
    if (curS && Array.from(sSelect.options).some(o => o.value === curS)) sSelect.value = curS;
  }

  function updateSubjects(prefix) {
    const cSelect = document.getElementById(prefix + '-course');
    const sSelect = document.getElementById(prefix + '-semester');
    const subSelect = document.getElementById(prefix + '-subject');
    if (!subSelect) return;

    const curSub = subSelect.value;
    subSelect.innerHTML = '<option value="">Select Subject</option>';

    const sVal = sSelect ? sSelect.value : '';
    const cVal = cSelect ? cSelect.value : '';
    const courseObj = allFilters.find(x => x.category === 'course' && x.value === cVal);
    const semObj = sVal && courseObj
      ? allFilters.find(x => x.category === 'semester' && x.value === sVal && x.parent_id === courseObj.id)
      : (sVal ? allFilters.find(x => x.category === 'semester' && x.value === sVal) : null);

    let subjects = semObj
      ? allFilters.filter(x => x.category === 'subject' && x.parent_id === semObj.id)
      : allFilters.filter(x => x.category === 'subject');
    subjects = subjects.sort((a, b) => a.value.localeCompare(b.value));
    uploadPopulateSelect(subSelect, subjects, 'Select Subject');
    if (curSub && Array.from(subSelect.options).some(o => o.value === curSub)) subSelect.value = curSub;
  }

  function uploadPopulateSelect(el, items, placeholder) {
    if (!el) return;
    el.innerHTML = '<option value="">' + placeholder + '</option>';
    items.forEach(i => {
      const opt = document.createElement('option');
      opt.value = i.value;
      opt.textContent = i.value;
      el.appendChild(opt);
    });
  }

  async function loadDocs() {
    const tbody = document.getElementById('doc-list');
    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-slate-500 font-medium">Scanning knowledge assets...</td></tr>';
    try {
      const res = await fetch('/api/admin/documents');
      const data = await res.json();
      // Filter out web sources for this page
      allDocs = (data || []).filter(d => !(d.filename || '').startsWith('[WEB] '));

      const courses = [...new Set(allDocs.map(d => d.course).filter(Boolean))].sort();
      const courseSelect = document.getElementById('course-filter');
      courseSelect.innerHTML = '<option value="">All Courses</option>';
      courses.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        courseSelect.appendChild(opt);
      });

      const semesters = [...new Set(allDocs.map(d => d.semester).filter(Boolean))].sort();
      const semSelect = document.getElementById('sem-filter');
      semSelect.innerHTML = '<option value="">All Semesters</option>';
      semesters.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        semSelect.appendChild(opt);
      });

      const subjects = [...new Set(allDocs.map(d => d.subject).filter(Boolean))].sort();
      const subjSelect = document.getElementById('subj-filter');
      if (subjSelect) {
        subjSelect.innerHTML = '<option value="">All Subjects</option>';
        subjects.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s; opt.textContent = s;
          subjSelect.appendChild(opt);
        });
      }
      renderDocs();
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading documents</td></tr>';
    }
  }
  function renderDocs() {
    const tbody = document.getElementById('doc-list');
    const systemTbody = document.getElementById('system-doc-list');
    const systemContainer = document.getElementById('system-docs-container');
    const emptyState = document.getElementById('empty-state');
    const search = document.getElementById('search-filter').value.toLowerCase();
    const course = document.getElementById('course-filter').value;
    const sem = document.getElementById('sem-filter').value;
    const subj = document.getElementById('subj-filter') ? document.getElementById('subj-filter').value : '';

    // Separate System Docs
    const systemDocs = allDocs.filter(d => d.doc_type === 'system_info');
    const syllabusDocs = allDocs.filter(d => d.doc_type !== 'system_info');

    // 1. Render System Docs
    if (systemTbody) {
      systemTbody.innerHTML = '';
      if (systemDocs.length > 0) {
        systemContainer.classList.remove('hidden');
        systemDocs.forEach(doc => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-slate-800/20 transition-colors';
          tr.innerHTML = `
            <td class="px-2 py-3">
              <div class="flex flex-col">
                <span class="text-xs font-bold text-white truncate max-w-[150px]" title="${doc.filename}">${doc.filename}</span>
                <span class="text-[10px] text-slate-600">${doc.upload_date ? new Date(doc.upload_date).toLocaleDateString() : 'N/A'}</span>
              </div>
            </td>
            <td class="px-2 py-3">
              <span class="px-1.5 py-0.5 rounded text-[9px] font-black uppercase ${doc.status === 'processed' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-slate-800 text-slate-500'}">
                ${doc.status}
              </span>
            </td>
            <td class="px-2 py-3 text-right">
              <button onclick="deleteDoc(${doc.id})" class="text-slate-500 hover:text-red-400 transition-colors">
                <i class="fa-solid fa-trash-can text-xs"></i>
              </button>
            </td>
          `;
          systemTbody.appendChild(tr);
        });
      } else {
        systemContainer.classList.add('hidden');
      }
    }

    // 2. Render Syllabus Docs (Main Table)
    const filtered = syllabusDocs.filter(doc => {
      // Don't show web sources in the general documents tab
      if (doc.filename.startsWith('[WEB] ')) return false;

      const matchesSearch = doc.filename.toLowerCase().includes(search);
      const matchesCourse = !course || doc.course === course;
      const matchesSem = !sem || doc.semester === sem;
      const matchesSubj = !subj || doc.subject === subj;
      return matchesSearch && matchesCourse && matchesSem && matchesSubj;
    });

    tbody.innerHTML = '';
    if (filtered.length === 0) {
      emptyState.classList.remove('hidden');
    } else {
      emptyState.classList.add('hidden');
      filtered.forEach(doc => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-800/40 transition-colors group';
        let statusClass = 'bg-slate-800 text-slate-400 border border-slate-700';
        let statusIcon = 'fa-circle';
        if (doc.status === 'processed') {
          statusClass = 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
          statusIcon = 'fa-check-circle';
        } else if (doc.status === 'error') {
          statusClass = 'bg-red-500/10 text-red-400 border border-red-500/20';
          statusIcon = 'fa-exclamation-circle';
        } else if (doc.status === 'pending') {
          statusClass = 'bg-amber-500/10 text-amber-500 border border-amber-500/20';
          statusIcon = 'fa-clock';
        }

        const date = doc.upload_date ? new Date(doc.upload_date).toLocaleDateString() : 'N/A';

        const courseBadge = `<span class="px-2 py-0.5 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${doc.course ? 'bg-indigo-500/10 text-indigo-400 border border-indigo-500/20' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${doc.course || 'Unknown'}</span>`;
        const semBadge = `<span class="px-2 py-0.5 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${doc.semester ? 'bg-violet-500/10 text-violet-400 border border-violet-500/20' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${doc.semester || 'Unknown'}</span>`;
        const subjBadge = `<span class="px-2 py-0.5 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${doc.subject ? 'bg-purple-500/10 text-purple-400 border border-purple-500/20' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${doc.subject || 'Unknown'}</span>`;

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 bg-indigo-500/10 rounded-lg flex items-center justify-center text-indigo-400 border border-indigo-500/20">
                <i class="fa-solid fa-file-alt"></i>
              </div>
              <div class="ml-4">
                <div class="text-sm font-bold text-white">${doc.filename}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${courseBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${semBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${subjBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 inline-flex text-[10px] font-black uppercase tracking-tighter rounded-full items-center ${statusClass}">
              <i class="fas ${statusIcon} mr-1.5 text-[8px]"></i> ${doc.status}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${date}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
            <a href="/admin/chunks?document_id=${doc.id}" class="btn-link"><i class="fa-solid fa-layer-group"></i> View chunks</a>
            <button type="button" onclick="deleteDoc(${doc.id})" class="btn-danger-ghost inline-flex items-center gap-1.5" title="Delete document and its chunks"><i class="fa-solid fa-trash-alt"></i> Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }

  async function deleteDoc(id) {
    if (!confirm('Are you sure you want to delete this document and all its chunks? This cannot be undone.')) return;
    try {
      const res = await fetch(`/api/admin/documents/${id}`, { method: 'DELETE' });
      if (res.ok) {
        allDocs = allDocs.filter(d => d.id !== id);
        renderDocs();
      } else {
        alert('Failed to delete document');
      }
    } catch (e) {
      alert('Error deleting document');
    }
  }

  // Upload form: file name display and submit
  const fileInput = document.getElementById('file-input');
  if (fileInput) fileInput.addEventListener('change', function () {
    const fn = document.getElementById('file-name');
    if (fn) fn.innerText = this.files.length > 0 ? this.files[0].name : '';
  });
  const uploadForm = document.getElementById('upload-form');
  if (uploadForm) uploadForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const status = document.getElementById('upload-status');
    const courseVal = (document.getElementById('upload-course') && document.getElementById('upload-course').value || '').trim();
    const semVal = (document.getElementById('upload-semester') && document.getElementById('upload-semester').value || '').trim();
    const subjVal = (document.getElementById('upload-subject') && document.getElementById('upload-subject').value || '').trim();
    if (!courseVal || !semVal || !subjVal) {
      status.innerText = 'Course, Semester, and Subject are required';
      status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      return;
    }
    if (!fileInput || fileInput.files.length === 0) {
      status.innerText = 'Please select a file to upload';
      status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      return;
    }
    const formData = new FormData(uploadForm);
    formData.append('file', fileInput.files[0]);
    status.innerText = 'Uploading...';
    status.className = 'mt-4 text-sm text-center text-indigo-400 font-bold animate-pulse';
    try {
      const res = await fetch('/api/admin/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok) {
        status.innerText = 'Success! File processed.';
        status.className = 'mt-4 text-sm text-center text-emerald-400 font-bold';
        fileInput.value = '';
        const fn = document.getElementById('file-name');
        if (fn) fn.innerText = '';
        loadDocs();
        setTimeout(function () { status.innerText = ''; }, 3000);
      } else {
        status.innerText = data.error || 'Upload failed';
        status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      }
    } catch (err) {
      status.innerText = 'Network error';
      status.className = 'mt-4 text-sm text-center text-red-600';
    }
  });

  // System Info Upload: file name display and submit
  const systemFileInput = document.getElementById('system-file-input');
  if (systemFileInput) systemFileInput.addEventListener('change', function () {
    const fn = document.getElementById('system-file-name');
    if (fn) fn.innerText = this.files.length > 0 ? this.files[0].name : '';
  });
  const systemUploadForm = document.getElementById('system-upload-form');
  if (systemUploadForm) systemUploadForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const status = document.getElementById('system-upload-status');
    if (!systemFileInput || systemFileInput.files.length === 0) {
      status.innerText = 'Please select a file to upload';
      status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      return;
    }
    const formData = new FormData(systemUploadForm);
    formData.append('file', systemFileInput.files[0]);
    status.innerText = 'Uploading...';
    status.className = 'mt-4 text-sm text-center text-indigo-400 font-bold animate-pulse';
    try {
      const res = await fetch('/api/admin/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok) {
        status.innerText = 'Success! System info processed.';
        status.className = 'mt-4 text-sm text-center text-emerald-400 font-bold';
        systemFileInput.value = '';
        const fn = document.getElementById('system-file-name');
        if (fn) fn.innerText = '';
        loadDocs();
        setTimeout(function () { status.innerText = ''; }, 3000);
      } else {
        status.innerText = data.error || 'Upload failed';
        status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      }
    } catch (err) {
      status.innerText = 'Network error';
      status.className = 'mt-4 text-sm text-center text-red-600';
    }
  });

  const websiteForm = document.getElementById('website-form');
  if (websiteForm) websiteForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const status = document.getElementById('web-status');
    const btn = document.getElementById('web-submit-btn');

    const urlVal = (document.getElementById('web-url') && document.getElementById('web-url').value || '').trim();

    if (!urlVal) {
      status.innerText = 'URL is required';
      status.className = 'mt-4 text-sm text-center text-red-600';
      return;
    }

    status.innerText = 'Scraping and indexing... This may take up to 60 seconds.';
    status.className = 'mt-4 text-sm text-center text-blue-600 animate-pulse';
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Processing...';

    try {
      const res = await fetch('/api/admin/add-website', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: urlVal
        })
      });
      const data = await res.json();
      if (res.ok) {
        status.innerText = data.message || 'Success! Website processed.';
        status.className = 'mt-4 text-sm text-center text-green-600';
        document.getElementById('web-url').value = '';
        loadDocs();
        setTimeout(function () { status.innerText = ''; }, 5000);
      } else {
        status.innerText = data.error || 'Scraping failed';
        status.className = 'mt-4 text-sm text-center text-red-600';
      }
    } catch (err) {
      status.innerText = 'Network error: ' + err.message;
      status.className = 'mt-4 text-sm text-center text-red-600';
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-robot"></i> Scrape & Index';
    }
  });



  // Initial load: filter options for upload dropdowns, then documents list
  loadFilterOptions().then(function () { loadDocs(); });

  // Tab Switching Logic
  function switchTab(tab) {
    const panels = {
      'syllabus': document.getElementById('panel-syllabus'),
      'system': document.getElementById('panel-system')
    };
    const buttons = {
      'syllabus': document.getElementById('tab-syllabus'),
      'system': document.getElementById('tab-system')
    };

    // Reset all
    Object.values(panels).forEach(p => p.classList.add('hidden'));
    Object.values(buttons).forEach(b => {
      b.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-900/40');
      b.classList.add('text-slate-500', 'hover:text-slate-300', 'hover:bg-slate-800/50');
    });

    // Activate selected
    panels[tab].classList.remove('hidden');
    const colorClass = tab === 'syllabus' ? 'bg-indigo-600' : 'bg-amber-600';
    buttons[tab].classList.add(colorClass, 'text-white', 'shadow-lg', 'shadow-indigo-900/40');
    buttons[tab].classList.remove('text-slate-500', 'hover:text-slate-300', 'hover:bg-slate-800/50');
  }

  // Listeners
  document.getElementById('course-filter').addEventListener('change', () => renderDocs());
  document.getElementById('sem-filter').addEventListener('change', () => renderDocs());
  const subjSelectEl = document.getElementById('subj-filter');
  if (subjSelectEl) {
    subjSelectEl.addEventListener('change', () => renderDocs());
  }
  document.getElementById('search-filter').addEventListener('input', () => renderDocs());
</script>
{% endblock %}